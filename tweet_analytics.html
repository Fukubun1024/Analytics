<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ツイートアナリティクス</title>

<style>
/* 全体の背景 */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
    color: #333;
}

/* ヘッダー */
header {
    background-color: #007bff;
    color: white;
    text-align: center;
    padding: 20px;
    font-size: 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* カード風デザイン */
.file-upload, .date-filter, .sort-buttons {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 20px;
    margin: 20px auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    text-align: center;
}

/* ボタンのスタイル */
button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
}

button:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
}

button:active {
    background-color: #004494;
    transform: translateY(0);
}

/* ファイル選択ボタンの余白調整 */
.file-upload input[type="file"] {
    margin-bottom: 10px;
}

/* 日付フォームのスタイル */
.date-filter {
    text-align: center;
}

.date-filter label {
    display: block; /* ラベルを縦に配置 */
    margin: 10px 0; /* ラベル間の余白を設定 */
}

.date-filter input[type="date"] {
    margin-left: 5px; /* ラベルとの間に余白 */
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 5px;
    width: auto; /* 幅を自動調整 */
}

.date-filter button {
    margin-top: 20px; /* ボタンをより下に配置 */
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
}

.date-filter button:hover {
    background-color: #0056b3;
}

/* プルダウンのスタイル */
.sort-buttons select {
    padding: 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 5px;
    width: calc(100% - 20px);
}

.sort-buttons p {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
    text-align: center;
}

/* 戻るボタンを中央揃え */
.back-button {
    text-align: center;
    margin: 20px;
}

.back-button a {
    display: inline-block;
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-size: 16px;
    transition: background-color 0.3s, transform 0.2s;
}

.back-button a:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.back-button a:active {
    background-color: #004494;
    transform: translateY(0);
}

/* ツイートリスト */
.tweet-list {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.tweet-item {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: background-color 0.3s, transform 0.2s;
    cursor: pointer;
}

.tweet-item:hover {
    background-color: #f9f9f9;
    transform: translateY(-2px);
}

.tweet-item h4 {
    margin: 0;
    font-size: 16px;
}

.tweet-details {
    margin-top: 10px;
    display: none;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.details-grid div {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.details-grid .label {
    font-weight: bold;
}

/* リンクスタイル */
.tweet-link {
    text-align: center;
    margin-top: 10px;
}

.tweet-link a {
    color: #007bff;
    text-decoration: none;
    transition: color 0.3s;
}

.tweet-link a:hover {
    text-decoration: underline;
    color: #0056b3;
}

/* スマホ向けのスタイル調整 */
@media (max-width: 600px) {
    .file-upload, .date-filter, .sort-buttons {
        width: 90%;
    }

    .date-filter input[type="date"],
    .sort-buttons select {
        font-size: 14px;
    }

    button {
        font-size: 14px;
        padding: 10px;
    }
}
</style>


</style>



</head>
<body>
    <header>ツイートアナリティクス</header>
    <div class="back-button">
        <a href="index.html">メインページに戻る</a>
    </div>
    <div class="file-upload">
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="processCSV()">取り込み</button>
    </div>
 <div class="date-filter" id="dateFilter" style="display: none;">
    <p><strong>【取り込み期間】</strong> <span id="importedRange">-</span></p>
    <label>開始日: <input type="date" id="startDate"></label>
    <label>終了日: <input type="date" id="endDate"></label>
    <button onclick="filterByDate()">期間で絞り込む</button>
</div>

<div class="sort-buttons" id="sortButtons" style="display: none;">
    <p>項目で並び替え</p>
    <select id="sortCriteria" onchange="sortByDropdown()">
        <option value="timeAsc">時系列昇順</option>
        <option value="timeDesc" selected>時系列降順</option>
        <option value="impressions">インプレッション</option>
            <option value="engagement">エンゲージ</option>
            <option value="engagementRate">エンゲージ率</option>
            <option value="retweet">リポスト</option>
            <option value="reply">リプライ</option>
            <option value="like">いいね</option>
            <option value="profileClick">プロフクリック</option>
            <option value="mediaEngagement">メディアのエンゲージ</option>
            <option value="mediaPlayback">メディアの再生数</option>
            <option value="urlClick">URLクリック</option>
            <option value="hashtagClick">ハッシュタグクリック</option>
            <option value="detailsClick">詳細のクリック</option>
        </select>
    </div>
    <div class="tweet-list" id="output"></div>

    <script>
        let allTweets = [];
        let filteredTweets = [];

        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) {
                alert("CSVファイルを選択してください！");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result.replace(/\r\n|\r|\n/g, '\n'); // 改行コードを統一


                const rows = [];
                let currentRow = [];
                let inQuotes = false;
                let currentField = '';

csvData.split('\n').forEach((line) => {
    for (const char of line) {
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = '';
        } else {
            currentField += char;
        }
    }

    if (!inQuotes) {
        currentRow.push(currentField.trim());
        rows.push(currentRow);
        currentRow = [];
        currentField = '';
    } else {
        currentField += '\n';
    }
});

                if (inQuotes) {
                    console.warn('警告: 未完了のフィールドが存在');
                }

               const headers = rows[0].map(header => header.trim()); // ヘッダーをトリムして柔軟に対応


                const tweetColIndex = headers.findIndex(header => header.includes("ツイート本文"));
                const timeColIndex = headers.findIndex(header => header.includes("時間"));
                const linkColIndex = headers.findIndex(header => header.includes("ツイートの固定リンク"));
                const impressionsColIndex = headers.findIndex(header => header.includes("インプレッション"));
                const engagementColIndex = headers.findIndex(header => header.includes("エンゲージメント"));
                const engagementRateColIndex = headers.findIndex(header => header.includes("エンゲージメント率"));
                const retweetColIndex = headers.findIndex(header => header.includes("リツイート"));
                const replyColIndex = headers.findIndex(header => header.includes("返信"));
                const likeColIndex = headers.findIndex(header => header.includes("いいね"));
                const profileClickColIndex = headers.findIndex(header => header.includes("ユーザープロフィールクリック"));
                const urlClickColIndex = headers.findIndex(header => header.includes("URLクリック数"));
                const detailsClickColIndex = headers.findIndex(header => header.includes("詳細クリック"));
                const mediaEngagementColIndex = headers.findIndex(header => header.includes("メディアのエンゲージ"));
                const mediaPlaybackColIndex = headers.findIndex(header => header.includes("メディアの再生数"));
                const hashtagClickColIndex = headers.findIndex(header => header.includes("ハッシュタグクリック"));

                if (
                    tweetColIndex === -1 || timeColIndex === -1 || linkColIndex === -1 || impressionsColIndex === -1 ||
                    engagementColIndex === -1 || engagementRateColIndex === -1 || retweetColIndex === -1 ||
                    replyColIndex === -1 || likeColIndex === -1 || profileClickColIndex === -1 || urlClickColIndex === -1 ||
                    detailsClickColIndex === -1 || mediaEngagementColIndex === -1 || mediaPlaybackColIndex === -1 ||
                    hashtagClickColIndex === -1
                ) {
                    alert("CSVのカラム名が正しくありません。ヘッダーを確認してください。");
                    return;
                }

                allTweets = rows.slice(1).map((row, index) => {
                    if (!row || row.length < headers.length) {
                        console.warn(`行 ${index + 2} が不完全: ${row}`);
                        return null;
                    }

                    const cells = row;
                    if (!cells[timeColIndex] || !cells[tweetColIndex]) {
                        console.warn(`行 ${index + 2} が無効: ${row}`);
                        return null;
                    }

                    const timeUTC = cells[timeColIndex];
                    const date = new Date(timeUTC + " UTC");
                    if (isNaN(date.getTime())) {
                        console.warn(`無効な日時: ${timeUTC} (行 ${index + 2})`);
                        return null;
                    }
                    const jstDate = new Date(date.getTime() + 9 * 60 * 60 * 1000);
                    const formattedTime = jstDate.toISOString().slice(0, 16).replace("T", " ").replace(/-/g, "/");

                    return {
                        tweet: cells[tweetColIndex] || "N/A",
                        time: formattedTime,
                        link: cells[linkColIndex] || "#",
                        impressions: parseInt(cells[impressionsColIndex], 10) || 0,
                        engagement: parseInt(cells[engagementColIndex], 10) || 0,
                        engagementRate: cells[engagementRateColIndex] ? (parseFloat(cells[engagementRateColIndex]) * 100).toFixed(2) + "%" : 0,
                        retweet: parseInt(cells[retweetColIndex], 10) || 0,
                        reply: parseInt(cells[replyColIndex], 10) || 0,
                        like: parseInt(cells[likeColIndex], 10) || 0,
                        profileClick: parseInt(cells[profileClickColIndex], 10) || 0,
                        urlClick: parseInt(cells[urlClickColIndex], 10) || 0,
                        detailsClick: parseInt(cells[detailsClickColIndex], 10) || 0,
                        mediaEngagement: parseInt(cells[mediaEngagementColIndex], 10) || 0,
                        mediaPlayback: parseInt(cells[mediaPlaybackColIndex], 10) || 0,
                        hashtagClick: parseInt(cells[hashtagClickColIndex], 10) || 0,
                        rawTime: jstDate
                    };
                }).filter(Boolean);

                const minDate = new Date(Math.min(...allTweets.map(tweet => tweet.rawTime)));
                const maxDate = new Date(Math.max(...allTweets.map(tweet => tweet.rawTime)));

                document.getElementById('importedRange').textContent = `${formatDateForDisplay(minDate)} - ${formatDateForDisplay(maxDate)}`;
                document.getElementById('dateFilter').style.display = 'block';
                document.getElementById('sortButtons').style.display = 'block';

                document.getElementById('startDate').value = formatDateForInput(minDate);
                document.getElementById('endDate').value = formatDateForInput(maxDate);

                filteredTweets = [...allTweets];
                document.getElementById('sortCriteria').value = 'timeDesc';
                sortByDropdown();
            };

            reader.readAsText(file, 'UTF-8');

        }

function sortByDropdown(criteria = null) {
    // ソート基準が指定されていない場合はプルダウンの値を使用
    const sortCriteria = criteria || document.getElementById('sortCriteria').value;

    if (sortCriteria === 'timeAsc') {
        filteredTweets.sort((a, b) => a.rawTime - b.rawTime);
    } else if (sortCriteria === 'timeDesc') {
        filteredTweets.sort((a, b) => b.rawTime - a.rawTime);
    } else {
        filteredTweets.sort((a, b) => b[sortCriteria] - a[sortCriteria]);
    }

    displayTweets(filteredTweets);
}


        function filterByDate() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            if (!startDate || !endDate || startDate > endDate) {
                alert("有効な期間を選択してください！");
                return;
            }

            const adjustedEndDate = new Date(endDate.getTime() + 24 * 60 * 60 * 1000 - 1);

filteredTweets = allTweets.filter(tweet => {
    return tweet.rawTime >= startDate && tweet.rawTime <= adjustedEndDate;
});

// 現在選択されているソート基準を適用
const currentSortCriteria = document.getElementById('sortCriteria').value;
sortByDropdown(currentSortCriteria);

            displayTweets(filteredTweets);
        }

        function displayTweets(tweets) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = "";

            tweets.forEach(tweet => {
                const tweetItem = document.createElement('div');
                tweetItem.className = 'tweet-item';
                tweetItem.innerHTML = `
                    <h4>${tweet.tweet}</h4>
                    <div class="time">${tweet.time}</div>
                    <div class="tweet-link"><a href="${tweet.link}" target="_blank">ツイートを見る</a></div>
                    <div class="tweet-details">
                        <div class="details-grid">
                            <div><span class="label">インプレッション</span><br>${tweet.impressions}</div>
                            <div><span class="label">エンゲージ</span><br>${tweet.engagement}</div>
                            <div><span class="label">エンゲージ率</span><br>${tweet.engagementRate}</div>
                            <div><span class="label">リポスト</span><br>${tweet.retweet}</div>
                            <div><span class="label">リプライ</span><br>${tweet.reply}</div>
                            <div><span class="label">いいね</span><br>${tweet.like}</div>
                            <div><span class="label">プロフクリック</span><br>${tweet.profileClick}</div>
                            <div><span class="label">メディアのエンゲージ</span><br>${tweet.mediaEngagement}</div>
                            <div><span class="label">メディアの再生数</span><br>${tweet.mediaPlayback}</div>
                            <div><span class="label">URLクリック</span><br>${tweet.urlClick}</div>
                            <div><span class="label">ハッシュタグクリック</span><br>${tweet.hashtagClick}</div>
                            <div><span class="label">詳細のクリック</span><br>${tweet.detailsClick}</div>
                        </div>
                    </div>
                `;
                tweetItem.addEventListener('click', function() {
                    const details = tweetItem.querySelector('.tweet-details');
                    details.style.display = details.style.display === 'none' || details.style.display === '' ? 'block' : 'none';
                });
                outputDiv.appendChild(tweetItem);
            });
        }

        function formatDateForDisplay(date) {
            const jstDate = new Date(date.getTime() + 9 * 60 * 60 * 1000);
            return jstDate.toISOString().slice(0, 10).replace(/-/g, '/');
        }

        function formatDateForInput(date) {
            return date.toISOString().slice(0, 10);
        }
    </script>
</body>
</html>
